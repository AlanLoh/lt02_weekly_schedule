#! /usr/bin/python3
# -*- coding: utf-8 -*-

__author__ = "Alan Loh"
__copyright__ = "Copyright 2025, exoschedule"
__credits__ = ["Alan Loh"]
__maintainer__ = "Alan"
__email__ = "alan.loh@obspm.fr"
__status__ = "Production"
__all__ = [

]

import pytest
import os
import itertools
from astropy.time import Time

from exoschedule.functions import bookings_from_vcr, booking_difference

# ============================================================= #
# ------------------ test_bookings_from_vcr ------------------- #
def test_bookings_from_vcr():
    result = bookings_from_vcr(
        vcr_current_booking=os.path.join(os.path.dirname(__file__), "test_data/2025-01-21_booking.csv"),
        start_time=Time("2025-02-03T00:00:00"),
        stop_time=Time("2025-02-10T00:00:00")
    )
    assert isinstance(result, list)
    assert len(result) == 20
    expected = [
        "2025-02-03T08:00:00.000",
        "2025-02-03T11:00:00.000",
        "2025-02-03T15:00:00.000",
        "2025-02-03T18:00:00.000",
        "2025-02-04T04:00:00.000",
        "2025-02-04T11:00:00.000",
        "2025-02-04T15:00:00.000",
        "2025-02-04T18:00:00.000",
        "2025-02-04T22:00:00.000",
        "2025-02-05T00:00:00.000",
        "2025-02-05T06:00:00.000",
        "2025-02-05T07:00:00.000",
        "2025-02-05T08:00:00.000",
        "2025-02-05T11:00:00.000",
        "2025-02-05T15:00:00.000",
        "2025-02-05T17:00:00.000",
        "2025-02-06T03:00:00.000",
        "2025-02-06T11:00:00.000",
        "2025-02-06T15:00:00.000",
        "2025-02-06T18:00:00.000",
        "2025-02-07T06:00:00.000",
        "2025-02-07T07:00:00.000",
        "2025-02-07T08:00:00.000",
        "2025-02-07T09:00:00.000",
        "2025-02-07T15:00:00.000",
        "2025-02-07T18:00:00.000",
        "2025-02-07T22:00:00.000",
        "2025-02-08T04:00:00.000",
        "2025-02-08T05:00:00.000",
        "2025-02-08T10:00:00.000",
        "2025-02-08T14:00:00.000",
        "2025-02-08T17:00:00.000",
        "2025-02-09T06:00:00.000",
        "2025-02-09T07:00:00.000",
        "2025-02-09T08:00:00.000",
        "2025-02-09T12:00:00.000",
        "2025-02-09T13:00:00.000",
        "2025-02-09T20:00:00.000",
        "2025-02-09T22:00:00.000",
        "2025-02-10T00:00:00.000"
    ]
    actual = list(itertools.chain(*[[res[0].isot, res[1].isot] for res in result]))
    assert all([a == b for a, b in zip(actual, expected)])

# ============================================================= #
# -------------- test_bookings_from_vcr_unmerged -------------- #
def test_bookings_from_vcr_unmerged():
    result = bookings_from_vcr(
        vcr_current_booking=os.path.join(os.path.dirname(__file__), "test_data/2025-01-21_booking.csv"),
        start_time=Time("2025-02-03T00:00:00"),
        stop_time=Time("2025-02-10T00:00:00"),
        merge_slots=False
    )
    assert isinstance(result, list)
    assert len(result) == 18
    expected = [
        "2025-02-03T08:00:00.000",
        "2025-02-03T11:00:00.000",
        "2025-02-03T15:00:00.000",
        "2025-02-03T18:00:00.000",
        "2025-02-04T08:00:00.000",
        "2025-02-04T11:00:00.000",
        "2025-02-04T15:00:00.000",
        "2025-02-04T18:00:00.000",
        "2025-02-05T06:00:00.000",
        "2025-02-05T07:00:00.000",
        "2025-02-05T08:00:00.000",
        "2025-02-05T11:00:00.000",
        "2025-02-05T15:00:00.000",
        "2025-02-05T17:00:00.000",
        "2025-02-06T03:00:00.000",
        "2025-02-06T04:00:00.000",
        "2025-02-06T08:00:00.000",
        "2025-02-06T11:00:00.000",
        "2025-02-06T15:00:00.000",
        "2025-02-06T18:00:00.000",
        "2025-02-07T06:00:00.000",
        "2025-02-07T07:00:00.000",
        "2025-02-07T08:00:00.000",
        "2025-02-07T09:00:00.000",
        "2025-02-07T15:00:00.000",
        "2025-02-07T18:00:00.000",
        "2025-02-08T05:00:00.000",
        "2025-02-08T10:00:00.000",
        "2025-02-08T14:00:00.000",
        "2025-02-08T17:00:00.000",
        "2025-02-09T06:00:00.000",
        "2025-02-09T07:00:00.000",
        "2025-02-09T08:00:00.000",
        "2025-02-09T12:00:00.000",
        "2025-02-09T13:00:00.000",
        "2025-02-09T20:00:00.000"
    ]
    actual = list(itertools.chain(*[[res[0].isot, res[1].isot] for res in result]))
    assert all([a == b for a, b in zip(actual, expected)])


# ============================================================= #
# ------------------ test_booking_difference ------------------ #
def test_booking_difference():
    b1 = [
        (Time("2025-01-01 00:00:00"), Time("2025-01-01 01:00:00")), # 1
        (Time("2025-01-01 03:00:00"), Time("2025-01-01 05:00:00")), # 2
        (Time("2025-01-01 06:00:00"), Time("2025-01-01 07:00:00")), # 3
        (Time("2025-01-01 08:00:00"), Time("2025-01-01 09:00:00")) # 4
    ]
    b2 = [
        (Time("2025-01-01 00:10:00"), Time("2025-01-01 00:20:00")), # within 1
        (Time("2025-01-01 01:10:00"), Time("2025-01-01 01:20:00")), # outside
        (Time("2025-01-01 03:10:00"), Time("2025-01-01 03:20:00")), # within 2
        (Time("2025-01-01 04:10:00"), Time("2025-01-01 04:20:00")), # within 2 bis
        (Time("2025-01-01 05:50:00"), Time("2025-01-01 06:10:00")), # intersecting 3 low edge
        (Time("2025-01-01 07:50:00"), Time("2025-01-01 09:10:00")) # completely englobing 4
        ]

    expected = [
        ("2025-01-01T00:00:00.000", "2025-01-01T00:10:00.000"),
        ("2025-01-01T00:20:00.000", "2025-01-01T01:00:00.000"),
        ("2025-01-01T03:00:00.000", "2025-01-01T03:10:00.000"),
        ("2025-01-01T03:20:00.000", "2025-01-01T04:10:00.000"),
        ("2025-01-01T04:20:00.000", "2025-01-01T05:00:00.000"),
        ("2025-01-01T06:10:00.000", "2025-01-01T07:00:00.000"),
    ]

    actual = booking_difference(
        b1,
        b2
    )
    actual = [(s.isot, e.isot) for s, e in sorted(actual)]

    for a, e in zip(actual, expected):
        assert a == e, f"{a} != {e}"